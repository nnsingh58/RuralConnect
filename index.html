<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rural Connect</title>
    <!-- React and Babel via CDN -->
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.20.15/babel.min.js"></script>
    <!-- Firebase Compatibility Scripts via CDN -->
    <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-storage-compat.js"></script>
    <!-- TailwindCSS via CDN -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Arial', sans-serif; }
        .category-container { @apply bg-gray-100 p-4 rounded-lg shadow-md; }
        .service-card { @apply bg-white p-3 m-2 rounded-lg shadow hover:shadow-lg transition; }
        .banner { @apply bg-blue-500 text-white p-4 rounded-lg mb-4; }
        .language-toggle { @apply fixed top-4 right-4 bg-gray-800 text-white px-3 py-1 rounded; }
        .chatbot { @apply fixed bottom-4 right-4 bg-blue-500 text-white p-4 rounded-full shadow-lg; }
        .error-message { @apply text-red-500 p-4 text-center; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        // Firebase Configuration (Replace with your ruralconnect-ttyvz config)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            databaseURL: "YOUR_DATABASE_URL",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase (with fallback)
        let auth, db, storage;
        let firebaseInitialized = false;
        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.database();
            storage = firebase.storage();
            firebaseInitialized = true;
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.warn("Firebase initialization failed. Using static mode:", error.message);
        }

        // Main App Component
        function App() {
            const [user, setUser] = useState(null);
            const [role, setRole] = useState('');
            const [language, setLanguage] = useState('en');
            const [searchQuery, setSearchQuery] = useState('');
            const [error, setError] = useState('');

            useEffect(() => {
                if (firebaseInitialized && auth) {
                    auth.onAuthStateChanged((user) => {
                        if (user) {
                            setUser(user);
                            db.ref('users/' + user.uid).once('value').then((snapshot) => {
                                setRole(snapshot.val()?.role || '');
                            }).catch((err) => {
                                setError('Failed to fetch user role: ' + err.message);
                            });
                        } else {
                            setUser(null);
                            setRole('');
                        }
                    });
                } else {
                    // Mock user for static preview
                    setUser({ uid: 'mock-user', phoneNumber: '+1234567890' });
                    setRole('customer');
                    console.log("Running in static mode with mock user");
                }
            }, []);

            const toggleLanguage = () => {
                setLanguage(language === 'en' ? 'hi' : 'en');
            };

            const handleSearch = (e) => {
                setSearchQuery(e.target.value);
            };

            if (error) {
                return <div className="error-message">{error}</div>;
            }

            return (
                <div className="min-h-screen bg-gray-50">
                    <button onClick={toggleLanguage} className="language-toggle">
                        {language === 'en' ? '‡§π‡§ø‡§®‡•ç‡§¶‡•Ä' : 'English'}
                    </button>
                    {user ? (
                        role === 'provider' ? (
                            <ProviderDashboard language={language} />
                        ) : role === 'admin' ? (
                            <AdminPanel language={language} />
                        ) : (
                            <CustomerDashboard 
                                language={language} 
                                searchQuery={searchQuery} 
                                handleSearch={handleSearch} 
                            />
                        )
                    ) : (
                        <AuthScreen language={language} />
                    )}
                </div>
            );
        }

        // Authentication Screen
        function AuthScreen({ language }) {
            const [phone, setPhone] = useState('');
            const [otp, setOtp] = useState('');
            const [role, setRole] = useState('customer');
            const [otpSent, setOtpSent] = useState(false);
            const [error, setError] = useState('');

            const sendOtp = () => {
                if (!firebaseInitialized || !auth) {
                    setError('Firebase not initialized. Please configure Firebase or use static mode.');
                    return;
                }
                try {
                    const recaptcha = new firebase.auth.RecaptchaVerifier('recaptcha', {
                        size: 'invisible'
                    });
                    auth.signInWithPhoneNumber(phone, recaptcha)
                        .then((confirmationResult) => {
                            window.confirmationResult = confirmationResult;
                            setOtpSent(true);
                            setError('');
                        })
                        .catch((error) => setError('Error sending OTP: ' + error.message));
                } catch (err) {
                    setError('Recaptcha initialization failed: ' + err.message);
                }
            };

            const verifyOtp = () => {
                if (!window.confirmationResult) {
                    setError('No OTP sent. Please send OTP first.');
                    return;
                }
                window.confirmationResult.confirm(otp)
                    .then((result) => {
                        const user = result.user;
                        db.ref('users/' + user.uid).set({
                            role,
                            phone,
                            address: '',
                            verified: false
                        }).catch((err) => {
                            setError('Failed to save user data: ' + err.message);
                        });
                        setError('');
                    })
                    .catch((error) => setError('OTP verification failed: ' + error.message));
            };

            return (
                <div className="flex items-center justify-center h-screen">
                    <div className="bg-white p-6 rounded-lg shadow-lg w-full max-w-md">
                        <h2 className="text-2xl font-bold mb-4">
                            {language === 'en' ? 'Login / Signup' : '‡§≤‡•â‡§ó‡§ø‡§® / ‡§∏‡§æ‡§á‡§®‡§Ö‡§™'}
                        </h2>
                        {error && <p className="text-red-500 mb-4">{error}</p>}
                        <input
                            type="text"
                            placeholder={language === 'en' ? 'Phone Number' : '‡§´‡•ã‡§® ‡§®‡§Ç‡§¨‡§∞'}
                            value={phone}
                            onChange={(e) => setPhone(e.target.value)}
                            className="w-full p-2 mb-4 border rounded"
                        />
                        <select
                            value={role}
                            onChange={(e) => setRole(e.target.value)}
                            className="w-full p-2 mb-4 border rounded"
                        >
                            <option value="customer">{language === 'en' ? 'Customer' : '‡§ó‡•ç‡§∞‡§æ‡§π‡§ï'}</option>
                            <option value="provider">{language === 'en' ? 'Service Provider' : '‡§∏‡•á‡§µ‡§æ ‡§™‡•ç‡§∞‡§¶‡§æ‡§§‡§æ'}</option>
                        </select>
                        {otpSent ? (
                            <>
                                <input
                                    type="text"
                                    placeholder={language === 'en' ? 'Enter OTP' : 'OTP ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç'}
                                    value={otp}
                                    onChange={(e) => setOtp(e.target.value)}
                                    className="w-full p-2 mb-4 border rounded"
                                />
                                <button
                                    onClick={verifyOtp}
                                    className="w-full bg-blue-500 text-white p-2 rounded"
                                >
                                    {language === 'en' ? 'Verify OTP' : 'OTP ‡§∏‡§§‡•ç‡§Ø‡§æ‡§™‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç'}
                                </button>
                            </>
                        ) : (
                            <>
                                <div id="recaptcha"></div>
                                <button
                                    onClick={sendOtp}
                                    className="w-full bg-blue-500 text-white p-2 rounded"
                                >
                                    {language === 'en' ? 'Send OTP' : 'OTP ‡§≠‡•á‡§ú‡•á‡§Ç'}
                                </button>
                            </>
                        )}
                    </div>
                </div>
            );
        }

        // Customer Dashboard
        function CustomerDashboard({ language, searchQuery, handleSearch }) {
            const categories = [
                {
                    name: language === 'en' ? 'Home Appliance Repair' : '‡§ò‡§∞‡•á‡§≤‡•Ç ‡§â‡§™‡§ï‡§∞‡§£ ‡§Æ‡§∞‡§Æ‡•ç‡§Æ‡§§',
                    icon: 'üîß',
                    services: [
                        'Fridge Repair', 'AC Repair', 'Washing Machine Repair', 'Cooler Repair',
                        'Ceiling Fan', 'Standing Fan', 'Submersible Pump'
                    ]
                },
                {
                    name: language === 'en' ? 'Electronics & Entertainment' : '‡§á‡§≤‡•á‡§ï‡•ç‡§ü‡•ç‡§∞‡•â‡§®‡§ø‡§ï‡•ç‡§∏ ‡§î‡§∞ ‡§Æ‡§®‡•ã‡§∞‡§Ç‡§ú‡§®',
                    icon: 'üì∫',
                    services: ['TV Repair', 'Radio Repair', 'LED Repair', 'Music System Repair']
                },
                {
                    name: language === 'en' ? 'Construction & Maintenance' : '‡§®‡§ø‡§∞‡•ç‡§Æ‡§æ‡§£ ‡§î‡§∞ ‡§∞‡§ñ‡§∞‡§ñ‡§æ‡§µ',
                    icon: 'üè†',
                    services: [
                        'Plumber', 'Borewell Expert', 'POP/Wall Painter', 'Mason',
                        'Labor Provider', 'Transport Services'
                    ]
                },
                {
                    name: language === 'en' ? 'Rural Specialty Services' : '‡§ó‡•ç‡§∞‡§æ‡§Æ‡•Ä‡§£ ‡§µ‡§ø‡§∂‡•á‡§∑ ‡§∏‡•á‡§µ‡§æ‡§è‡§Å',
                    icon: 'üöú',
                    services: [
                        'Agricultural Equipment Repair', 'Tractor/Trolley Mechanic', 'Livestock Care Services'
                    ]
                },
                {
                    name: language === 'en' ? 'Emergency Services' : '‡§Ü‡§™‡§æ‡§§‡§ï‡§æ‡§≤‡•Ä‡§® ‡§∏‡•á‡§µ‡§æ‡§è‡§Å',
                    icon: '‚ö°',
                    services: ['Electrician', 'Well Repair', 'Urgent Plumber']
                }
            ];

            return (
                <div className="p-4">
                    <div className="banner">
                        {language === 'en' ? 'Special Offer: 10% OFF on First Booking!' : '‡§µ‡§ø‡§∂‡•á‡§∑ ‡§ë‡§´‡§∞: ‡§™‡§π‡§≤‡•Ä ‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó ‡§™‡§∞ 10% ‡§õ‡•Ç‡§ü!'}
                    </div>
                    <input
                        type="text"
                        placeholder={language === 'en' ? 'Search services or voice search...' : '‡§∏‡•á‡§µ‡§æ‡§è‡§Å ‡§ñ‡•ã‡§ú‡•á‡§Ç ‡§Ø‡§æ ‡§µ‡•â‡§Ø‡§∏ ‡§∏‡§∞‡•ç‡§ö...'}
                        value={searchQuery}
                        onChange={handleSearch}
                        className="w-full p-2 mb-4 border rounded"
                    />
                    <button className="bg-blue-500 text-white p-2 rounded mb-4">
                        {language === 'en' ? 'Voice Search' : '‡§µ‡•â‡§Ø‡§∏ ‡§∏‡§∞‡•ç‡§ö'}
                    </button>
                    {categories.map((category) => (
                        <div key={category.name} className="category-container mb-4">
                            <h3 className="text-xl font-bold mb-2">{category.icon} {category.name}</h3>
                            <div className="flex flex-wrap">
                                {category.services
                                    .filter((service) => service.toLowerCase().includes(searchQuery.toLowerCase()))
                                    .map((service) => (
                                        <div key={service} className="service-card">
                                            <p>{service}</p>
                                            <button
                                                onClick={() => alert(`Booking ${service}. Redirecting to payment...`)}
                                                className="bg-green-500 text-white px-2 py-1 rounded mt-2"
                                            >
                                                {language === 'en' ? 'Book Now' : '‡§Ö‡§≠‡•Ä ‡§¨‡•Å‡§ï ‡§ï‡§∞‡•á‡§Ç'}
                                            </button>
                                        </div>
                                    ))}
                            </div>
                        </div>
                    ))}
                    <Chatbot language={language} />
                </div>
            );
        }

        // Provider Dashboard
        function ProviderDashboard({ language }) {
            const [documents, setDocuments] = useState({ aadhaar: null, license: null });

            const handleDocumentUpload = (e, type) => {
                if (!firebaseInitialized || !storage) {
                    alert('Firebase Storage not initialized. Configure Firebase to upload documents.');
                    return;
                }
                const file = e.target.files[0];
                const uploadTask = storage.ref(`documents/${auth.currentUser.uid}/${type}`).put(file);
                uploadTask.on(
                    'state_changed',
                    null,
                    (error) => alert('Upload failed: ' + error.message),
                    () => {
                        setDocuments({ ...documents, [type]: file.name });
                    }
                );
            };

            return (
                <div className="p-4">
                    <h2 className="text-2xl font-bold mb-4">
                        {language === 'en' ? 'Provider Dashboard' : '‡§∏‡•á‡§µ‡§æ ‡§™‡•ç‡§∞‡§¶‡§æ‡§§‡§æ ‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§°'}
                    </h2>
                    <div className="bg-white p-4 rounded-lg shadow mb-4">
                        <h3 className="text-lg font-semibold mb-2">
                            {language === 'en' ? 'Upload Documents' : '‡§¶‡§∏‡•ç‡§§‡§æ‡§µ‡•á‡§ú‡§º ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç'}
                        </h3>
                        <input
                            type="file"
                            onChange={(e) => handleDocumentUpload(e, 'aadhaar')}
                            className="mb-2"
                        />
                        <p>{documents.aadhaar ? `Aadhaar: ${documents.aadhaar}` : 'No Aadhaar uploaded'}</p>
                        <input
                            type="file"
                            onChange={(e) => handleDocumentUpload(e, 'license')}
                            className="mb-2"
                        />
                        <p>{documents.license ? `License: ${documents.license}` : 'No License uploaded'}</p>
                    </div>
                    <button className="bg-blue-500 text-white p-2 rounded">
                        {language === 'en' ? 'View Bookings' : '‡§¨‡•Å‡§ï‡§ø‡§Ç‡§ó‡•ç‡§∏ ‡§¶‡•á‡§ñ‡•á‡§Ç'}
                    </button>
                </div>
            );
        }

        // Admin Panel (Placeholder)
        function AdminPanel({ language }) {
            return (
                <div className="p-4">
                    <h2 className="text-2xl font-bold mb-4">
                        {language === 'en' ? 'Admin Panel' : '‡§™‡•ç‡§∞‡§∂‡§æ‡§∏‡§® ‡§™‡•à‡§®‡§≤'}
                    </h2>
                    <div className="bg-white p-4 rounded-lg shadow mb-4">
                        <h3 className="text-lg font-semibold mb-2">
                            {language === 'en' ? 'Manage Providers' : '‡§™‡•ç‡§∞‡§¶‡§æ‡§§‡§æ‡§ì‡§Ç ‡§ï‡•ã ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç'}
                        </h3>
                        <button className="bg-green-500 text-white p-2 rounded mr-2">
                            {language === 'en' ? 'Approve Providers' : '‡§™‡•ç‡§∞‡§¶‡§æ‡§§‡§æ‡§ì‡§Ç ‡§ï‡•ã ‡§∏‡•ç‡§µ‡•Ä‡§ï‡•É‡§§ ‡§ï‡§∞‡•á‡§Ç'}
                        </button>
                        <button className="bg-red-500 text-white p-2 rounded">
                            {language === 'en' ? 'Reject Providers' : '‡§™‡•ç‡§∞‡§¶‡§æ‡§§‡§æ‡§ì‡§Ç ‡§ï‡•ã ‡§Ö‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞ ‡§ï‡§∞‡•á‡§Ç'}
                        </button>
                    </div>
                    <div className="bg-white p-4 rounded-lg shadow mb-4">
                        <h3 className="text-lg font-semibold mb-2">
                            {language === 'en' ? 'Monitor Transactions' : '‡§≤‡•á‡§®‡§¶‡•á‡§® ‡§ï‡•Ä ‡§®‡§ø‡§ó‡§∞‡§æ‡§®‡•Ä ‡§ï‡§∞‡•á‡§Ç'}
                        </h3>
                        <p>{language === 'en' ? 'View transaction logs' : '‡§≤‡•á‡§®‡§¶‡•á‡§® ‡§≤‡•â‡§ó ‡§¶‡•á‡§ñ‡•á‡§Ç'}</p>
                    </div>
                    <div className="bg-white p-4 rounded-lg shadow">
                        <h3 className="text-lg font-semibold mb-2">
                            {language === 'en' ? 'Broadcast Notifications' : '‡§™‡•ç‡§∞‡§∏‡§æ‡§∞‡§£ ‡§∏‡•Ç‡§ö‡§®‡§æ‡§è‡§Å'}
                        </h3>
                        <textarea
                            placeholder={language === 'en' ? 'Enter notification message...' : '‡§∏‡•Ç‡§ö‡§®‡§æ ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç...'}
                            className="w-full p-2 border rounded mb-2"
                        />
                        <button className="bg-blue-500 text-white p-2 rounded">
                            {language === 'en' ? 'Send Notification' : '‡§∏‡•Ç‡§ö‡§®‡§æ ‡§≠‡•á‡§ú‡•á‡§Ç'}
                        </button>
                    </div>
                </div>
            );
        }

        // Chatbot Component (Placeholder)
        function Chatbot({ language }) {
            return (
                <div className="chatbot">
                    <p>{language === 'en' ? 'Chat with us!' : '‡§π‡§Æ‡§∏‡•á ‡§ö‡•à‡§ü ‡§ï‡§∞‡•á‡§Ç!'}</p>
                </div>
            );
        }

        // Render the App with Error Boundary
        class ErrorBoundary extends React.Component {
            state = { error: null };
            static getDerivedStateFromError(error) {
                return { error: error.message };
            }
            render() {
                if (this.state.error) {
                    return <div className="error-message">Error: {this.state.error}</div>;
                }
                return this.props.children;
            }
        }

        ReactDOM.render(
            <ErrorBoundary>
                <App />
            </ErrorBoundary>,
            document.getElementById('root')
        );

        // PWA Service Worker
        if ('serviceWorker' in navigator && window.location.protocol === 'https:') {
            navigator.serviceWorker.register('/sw.js')
                .then(() => console.log('Service Worker Registered'))
                .catch((error) => console.log('Service Worker Registration Failed:', error));
        }
    </script>
</body>
</html>
